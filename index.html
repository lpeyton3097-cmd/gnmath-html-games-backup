<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Controller Player 2026</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        background: #1a1a1a;
        color: white;
        text-align: center;
    }
    .controls {
        background: #333;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .game-container {
        position: relative;
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        background: #000;
    }
    iframe {
        width: 100%;
        height: 600px;
        border: 2px solid #444;
        background: #000;
        display: block;
        outline: none;
    }
    .btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
    }
    .btn:disabled {
        background: #555;
    }
    .game-container:fullscreen {
        width: 100vw;
        height: 100vh;
        max-width: none;
    }
    .game-container:fullscreen iframe {
        height: 100vh;
        border: none;
    }
</style>
</head>

<body>

<div class="controls">
    <h2>Unrestricted Asset Loader</h2>
    <input type="file" id="fileSelector" multiple>
    <button id="fullscreenBtn" class="btn" disabled>Go Fullscreen</button>
    <p><small>Upload HTML + JS + images. Click game area to lock controls.</small></p>
</div>

<div id="gameContainer" class="game-container">
    <iframe id="displayFrame" allow="fullscreen; autoplay; gamepad; keyboard-lock; pointer-lock; local-network-access" tabindex="0"></iframe>
</div>

<script>
const fileSelector = document.getElementById('fileSelector');
const displayFrame = document.getElementById('displayFrame');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const gameContainer = document.getElementById('gameContainer');

let htmlFile = null;
let jsFiles = [];
let imageFiles = [];

// ------------------------------
// FILE LOADING
// ------------------------------
fileSelector.addEventListener('change', async function (e) {
    const files = Array.from(e.target.files);

    htmlFile = files.find(f => f.name.endsWith(".html"));
    jsFiles = files.filter(f => f.name.endsWith(".js"));
    imageFiles = files.filter(f => /\.(png|jpg|jpeg|gif|webp)$/i.test(f.name));

    if (!htmlFile) {
        alert("You must upload at least one HTML file.");
        return;
    }

    const htmlText = await htmlFile.text();
    let finalHTML = htmlText;

    // Inject JS files
    for (const js of jsFiles) {
        const jsText = await js.text();
        finalHTML += `<script>${jsText}<\/script>`;
    }

    // Replace image references with Base64
    for (const img of imageFiles) {
        const base64 = await fileToBase64(img);
        const regex = new RegExp(img.name, "g");
        finalHTML = finalHTML.replace(regex, base64);
    }

    displayFrame.srcdoc = finalHTML;
    fullscreenBtn.disabled = false;
});

function fileToBase64(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
    });
}

// ------------------------------
// FOCUS + KEYBOARD LOCK
// ------------------------------
function syncFocus() {
    displayFrame.contentWindow.focus();
    displayFrame.focus();
}

async function requestKeyboardLock() {
    if (navigator.keyboard && navigator.keyboard.lock) {
        try {
            await navigator.keyboard.lock();
            console.log("Keyboard lock enabled");
        } catch (e) {
            console.warn("Keyboard lock failed:", e);
        }
    }
}

// Fallback: forward key events to iframe
document.addEventListener("keydown", (e) => {
    if (!displayFrame.contentWindow) return;
    displayFrame.contentWindow.dispatchEvent(new KeyboardEvent("keydown", e));
});
document.addEventListener("keyup", (e) => {
    if (!displayFrame.contentWindow) return;
    displayFrame.contentWindow.dispatchEvent(new KeyboardEvent("keyup", e));
});

// ------------------------------
// POINTER LOCK + KEYBOARD LOCK ON CLICK
// ------------------------------
gameContainer.addEventListener("mousedown", async () => {
    syncFocus();

    if (displayFrame.requestPointerLock) {
        displayFrame.requestPointerLock();
    }

    requestKeyboardLock();
});

// ------------------------------
// FULLSCREEN
// ------------------------------
fullscreenBtn.addEventListener('click', () => {
    if (gameContainer.requestFullscreen) gameContainer.requestFullscreen();
    else if (gameContainer.webkitRequestFullscreen) gameContainer.webkitRequestFullscreen();
    syncFocus();
});

document.addEventListener('fullscreenchange', syncFocus);

displayFrame.onload = () => setTimeout(syncFocus, 100);
</script>

</body>
</html>
